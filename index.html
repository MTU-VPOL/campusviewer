<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>MTU Historical Campus Photo Viewer</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>  
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
<script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
  <script src="https://cdn.jsdelivr.net/npm/openseadragon@4.1.0/build/openseadragon/openseadragon.min.js"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    /*Map container*/
#viewDiv {
  position: absolute;
  top: 0;
  bottom: 0;        
  padding: 0;         
  width: 100%;
  margin-top: 56px;
}

.esri-ui .esri-popup  {
  display:  none !important;
 }  

ion-split-pane {
  --side-width: 50%;
  --side-max-width: 50%; 
  --border: none;
}

 ion-range {
  width: 30%;
  position: absolute;
  top:65px;
  left: 50px;
 }

 .responsive {
  width: 100%;
  height: auto;
}



.pulsing-dot{
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
    width: 20px;
    height: 20px;
    background-color: rgb(255, 0, 0);
    color: white;
    text-align: center;
    line-height: 100px;
    font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
    border-radius: 50%;
    font-size: 1.3rem;
    &:hover{
        cursor: pointer;
    }
    &::after,&::before{
        content: "";
        display: block;
        position: absolute;
        top:0;
        left:0;
        width: 20px;
        height: 20px;
        background: rgba(255, 0, 0,1);
        border-radius: 50%;
        z-index: -1;
        animation: grow 1.3s ease-in-out infinite;
    }
    &::after{
        background: rgba(255, 0, 0,0.4);
        &::before{
        content: "";
        display: block;
        position: absolute;
        top:0;
        left:0;
        width: 20px;
        height: 20px;
        background: rgb(95, 132, 255);
        border-radius: 50%;
        z-index: -1;
        animation: grow 1.3s ease-in-out infinite;
        }
    }
    &::before{
        background: rgba(255, 0, 0,.6);
        animation-delay: -0.5s;
    }
}
@keyframes grow{
    0%{
        transform: scale(1,1);
        opacity: 1;
    }
    100%{
        transform: scale(1.8,1.8);
        opacity: 0;
    }
}

  </style>
  <script>
  require([
    "esri/config",
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/layers/TileLayer",
    "esri/core/reactiveUtils"
  ], function(esriConfig, Map, MapView, FeatureLayer, TileLayer,  reactiveUtils) {

   var modal = document.querySelector('ion-modal');

    modal.isOpen = true;

  const viewer = OpenSeadragon({
    id: "openseadragon1",
    prefixUrl: "https://cdn.jsdelivr.net/npm/openseadragon@2.4/build/openseadragon/images/",
    maxZoomLevel: null, 
    //tileSources: {
     // type: "image",
    //  url: "https://cchi-iif.mtu.edu/iiif/3/MTU%20Neg%2000855.tif/full/max/0/default.jpg"
   // },   
  });

  const map = new Map({
    basemap: "satellite"
  });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [-88.54608828541998, 47.11898716569741],
    zoom: 19
  });
  
  const renderer = {
    type: "simple",  // autocasts as new SimpleRenderer()
    symbol: {
      type: "simple-fill",  // autocasts as new SimpleFillSymbol()
      color: [ 255, 128, 0, 0 ],
      outline: {  // autocasts as new SimpleLineSymbol()
        width: 3,
        color: "red"
      }
    }
  }; 

  const footprints = new FeatureLayer({
    url: "https://services2.arcgis.com/RPhrOu9XQzI31xTa/arcgis/rest/services/Campus_Buildings/FeatureServer/0",
    popupEnabled: true,
    definitionExpression: "BldgYear = 1900",
    renderer: renderer,
    outFields: ["*"]
  });

  map.add(footprints, 1);
/*
  const sanborn_1908 = new TileLayer({
    url: "https://portal1-geo.sabu.mtu.edu:6443/arcgis/rest/services/KeweenawHSDI/KeTT_1900_FIPS/MapServer"
  });

  map.add(sanborn_1908, 0);
*/
  // Create a popup template for the photos layer
  footprints.popupTemplate = {
    title:'footprint',
    content: "Description"    
  };

  // Create an object to store tile layers
  const tileLayers = {
    map_1949: new TileLayer({
      url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/KeweenawHSDI/Kett_19496_FIPS/MapServer?f=jsapi",
    }),
    map_1900: new TileLayer({
      url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/KeweenawHSDI/KeTT_1900_FIPS/MapServer",
    }),
    map_1908: new TileLayer({
      url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/KeweenawHSDI/KeTT_1908_FIPS/MapServer",
    }),
    map_1917: new TileLayer({
      url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/KeweenawHSDI/KeTT_1917_FIPS/MapServer",    
    }),
     map_1928: new TileLayer({
      url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/KeweenawHSDI/KeTT_1928_FIPS/MapServer",    
    }), 
     map_1954: new TileLayer({
      url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/mtu1955/MapServer",    
    }), 
     map_1955: new TileLayer({
      url: "https://tiles.arcgis.com/tiles/RPhrOu9XQzI31xTa/arcgis/rest/services/campus1955/MapServer",    
    }), 
     map_1965: new TileLayer({
      url: "https://tiles.arcgis.com/tiles/RPhrOu9XQzI31xTa/arcgis/rest/services/MTU_Campus_1965/MapServer",    
    }),
  }; 

   const range = document.querySelector('ion-range');
  
  // Switches the building footprints and map based on the year selected
  function goToYear (year) {
    // filter the building footprints based on the year
    footprints.definitionExpression = "BldgYear = " + year + "AND PhotoXY is not null";

    // Keep track of the currently active tile layers
    let activeTileLayer = null;
    // get variable from attributes for the map year string
    const mapstr = "map_" + year;
    console.log(mapstr);
    // Remove the previously active tile layer, if any
    if (activeTileLayer) {
      map.remove(activeTileLayer);
    }

    // Retrieve the tile layer from the tileLayers object
    const tileLayerToAdd = tileLayers[mapstr];

    if (tileLayerToAdd) {
      // Add the retrieved tile layer to the map
      map.add(tileLayerToAdd, 0);
      activeTileLayer = tileLayerToAdd; // Update the active layer
      // get the value of the range slider  
      let rangeVal = $( "ion-range" ).val();
     
      activeTileLayer.opacity = rangeVal / 100;        
     
      // adjust the transparency of the map based on the sliders value  
      range.addEventListener('ionInput', ({ detail }) => {                     
          activeTileLayer.opacity = detail.value / 100;                  
      });               
    } else {
      console.log("Tile layer not found for the given map year:", year);
    }
    // Go to the extent of the data
    footprints
    .when(() => {
      return footprints.queryExtent();
    })
    .then((response) => {
      view.goTo(response.extent);
    });
  }

  goToYear(1955);
  
  viewer.addHandler('open', function() {
    var tiledImage = viewer.world.getItemAt(0);
    var imgWidth = tiledImage.getContentSize().x;
    var imgHeight = tiledImage.getContentSize().y;    
    console.log("Image dimensions in pixels:", imgWidth, imgHeight);
  });

  viewer.addHandler('canvas-click', function(event) {
    // The canvas-click event gives us a position in web coordinates.
    var webPoint = event.position;

    // Convert that to viewport coordinates, the lingua franca of OpenSeadragon coordinates.
    var viewportPoint = viewer.viewport.pointFromPixel(webPoint);

    // Convert from viewport coordinates to image coordinates.
    var imagePoint = viewer.viewport.viewportToImageCoordinates(viewportPoint);

    // Show the results.
    console.log(webPoint.toString(), viewportPoint.toString(), imagePoint.toString());
  });

  // the image does not have an overlay
  var overlay = false;

  // keep track of the current image
  let currentImg = null;  

 // watch for a click on the building footprints  
 reactiveUtils.watch(
  () => view.popup.selectedFeature,
  (graphic) => {
    if (graphic) {       
    console.log(graphic);
    //const imgDesc = graphic.attributes.image_desc;
    //const imgUrl = graphic.attributes.image_url;
    const imgCoords = graphic.attributes.PhotoXY;
    const desc = graphic.attributes.Description;    
    const photoid = graphic.attributes.PhotoID;
    const year = graphic.attributes.BldgYear; 
    const map = graphic.attributes.Map;
    console.log(photoid);
     if (currentImg != photoid) {
      console.log("not equal");
    }

    currentImg = photoid;

    console.log(currentImg);

    if (imgCoords != null) {

     // Construct the new IIIF URL
    const newTileSource = "https://cchi-iif.mtu.edu/iiif/3/" + encodeURIComponent(photoid) + "/full/max/0/default.jpg";
    console.log("New tile source URL:", newTileSource);

    // Try opening the new tile source
    viewer.open({
        type: "image",
        url: newTileSource
    })  

    const coordsArr = imgCoords.split(",");
    console.log(coordsArr);

    console.log(overlay);

    // if there is an overlay on the image, remove it
    if (overlay == true) {
      viewer.removeOverlay("img-pin");        
    } 

     viewer.addHandler('open', function() {

      if (overlay == true) {
        viewer.removeOverlay("img-pin");        
      } 
    const tiledImage = viewer.world.getItemAt(0);

    // Convert string values to floats
    const imageX = parseFloat(coordsArr[0]);
    const imageY = parseFloat(coordsArr[1]);

    console.log(imageX, imageY);

 // Convert the image coordinates to viewport coordinates
 var viewportPoint = tiledImage.imageToViewportCoordinates(new OpenSeadragon.Point(imageX, imageY));


 // Create an HTML element for the pin
  var pin = document.createElement("img");
  pin.src = "https://upload.wikimedia.org/wikipedia/commons/d/d1/Google_Maps_pin.svg"; // URL to the map marker pin image
  pin.id = "map-pin";
  pin.className = "highlight";

   // Style your pin as needed (optional)
 // pin.style.width = "32px"; // Example size, adjust as needed
 // pin.style.height = "32px";
 // pin.style.transform = "translate(-50%, -100%)"; // Adjust the pin position relative to the point

   // Create an HTML element for the dot
  var dot = document.createElement("div");
  dot.className = "pulsing-dot";
  dot.id = "img-pin"
  
  // Adjust as necessary to center the dot over the point
  dot.style.transform = "translate(-50%, -50%)";

// Add the overlay with normalized coordinates
viewer.addOverlay({
  element: dot,
  location: viewportPoint 
});    

var deltaX = .2; // Example value, adjust based on how much area you want to show
var deltaY = .2; // Example value, adjust based on how much area you want to show
var bounds = new OpenSeadragon.Rect(viewportPoint.x - deltaX, viewportPoint.y - deltaY, 2 * deltaX, 2 * deltaY);

viewer.viewport.fitBounds(bounds, true); // The second parameter enables smooth animation
//document.getElementById("title").innerHTML = address + ", " + place_name;

});

// Center the viewport on the point
//viewer.viewport.panTo(viewportPoint, true);
// zoom to the point on the image
//viewer.viewport.zoomTo(2, viewportPoint, true);
   // now that there is an overlay set the variable to true 
    overlay = true;
  }
}
  });

});
</script>

</head>
<body>
<ion-app>
  <ion-modal trigger="open-modal">
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button onclick="cancel()">Cancel</ion-button>
        </ion-buttons>
        <ion-title>Choose Historic Campus Year</ion-title>
        <ion-buttons slot="end">
          <ion-button onclick="confirm()" strong="true">Confirm</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
     <ion-card>
  <img alt="Silhouette of mountains" src="https://ionicframework.com/docs/img/demos/card-media.png" />
  <ion-card-header>
    <ion-card-title>Card Title</ion-card-title>
    <ion-card-subtitle>Card Subtitle</ion-card-subtitle>
  </ion-card-header>

  <ion-card-content>
    Here's a small text description for the card content. Nothing more, nothing less.
  </ion-card-content>
</ion-card>
<ion-card>
  <img alt="Silhouette of mountains" src="https://ionicframework.com/docs/img/demos/card-media.png" />
  <ion-card-header>
    <ion-card-title>Card Title</ion-card-title>
    <ion-card-subtitle>Card Subtitle</ion-card-subtitle>
  </ion-card-header>

  <ion-card-content>
    Here's a small text description for the card content. Nothing more, nothing less.
  </ion-card-content>
</ion-card>
<ion-card>
  <img alt="Silhouette of mountains" src="https://ionicframework.com/docs/img/demos/card-media.png" />
  <ion-card-header>
    <ion-card-title>Card Title</ion-card-title>
    <ion-card-subtitle>Card Subtitle</ion-card-subtitle>
  </ion-card-header>

  <ion-card-content>
    Here's a small text description for the card content. Nothing more, nothing less.
  </ion-card-content>
</ion-card>
    </ion-content>
  </ion-modal>
  <ion-split-pane when="xs" content-id="main">
  <ion-menu content-id="main">
    <ion-header>
      <ion-toolbar color="dark">     
       <ion-buttons slot="start">
        <ion-img src="husky.svg" style="width: 50px; height: 50px;"></ion-img>
      </ion-buttons>  
      <ion-title>Historic Campus Photo Viewer</ion-title>    
  </ion-toolbar>
    </ion-header>
    <ion-content">
      <div id="viewDiv"></div>
      <ion-range value="100" mode="ios"></ion-range> 
    </ion-content>
  </ion-menu>

  <div class="ion-page" id="main">
    <ion-header>
      <ion-toolbar color="dark">        
      </ion-toolbar>
    </ion-header>
    <ion-content>
     <div id='openseadragon1' class="responsive"></div> </ion-content>
  </div>
</ion-split-pane>
</ion-app">
</body>
</html>